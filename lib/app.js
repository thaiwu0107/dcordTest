"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const inversify_binding_decorators_1 = require("inversify-binding-decorators");
const inversify_koa_utils_1 = require("inversify-koa-utils");
const Redis = require("ioredis");
const bodyParser = require("koa-bodyparser");
const jwt = require("koa-jwt");
const log4js = require("koa-log4");
const multer = require("koa-multer");
const Router = require("koa-router");
const cors = require("koa2-cors");
const _ = require("lodash");
const defConfig = require("./config/defconfig");
const ioc_1 = require("./ioc/ioc");
const iocTracer_1 = require("./ioc/iocTracer");
const log4js_1 = require("./middlewares/logger/log4js");
const GamaResponse_1 = require("./models/GamaResponse");
const log = log4js.getLogger('App');
class GServer {
    constructor(initSetting) {
        let middlewares;
        let domainName;
        // let mqSetting;
        let jwtPrivateKey;
        let jwtActive;
        let httpPort;
        let corsWhitelist;
        let log4;
        if (!_.isUndefined(initSetting)) {
            middlewares = _.isUndefined(initSetting.middlewares) ? undefined : initSetting.middlewares;
            if (_.size(middlewares) === 0) {
                middlewares = undefined;
            }
            this.serverInitOnceEvents = _.isUndefined(initSetting.iniData) ? undefined : initSetting.iniData;
            corsWhitelist = _.isUndefined(initSetting.corsWhitelist) ? undefined : initSetting.corsWhitelist;
            domainName = _.isUndefined(initSetting.domainName) ? undefined : initSetting.domainName;
            // mqSetting = _.isUndefined(initSetting.mqSetting) ? undefined : initSetting.mqSetting;
            jwtPrivateKey = _.isUndefined(initSetting.jwtPrivateKey) ?
                defConfig.jwt.privateKey : initSetting.jwtPrivateKey;
            jwtActive = _.isUndefined(initSetting.jwtActive) ? defConfig.jwt.active : initSetting.jwtActive;
            httpPort = _.isUndefined(initSetting.httpPort) ? defConfig.httpPort : initSetting.httpPort;
            httpPort = _.isUndefined(initSetting.httpPort) ? defConfig.httpPort : initSetting.httpPort;
            log4 = _.isFunction(initSetting.log4) ? log4js_1.default : initSetting.log4;
            ioc_1.container.load(inversify_binding_decorators_1.buildProviderModule());
            if (initSetting.filtersOpen) {
                const iocTracer = new iocTracer_1.default(initSetting.filters);
                iocTracer.apply(ioc_1.container);
            }
        }
        this.main = Promise.resolve(new Redis(initSetting.pathdb))
            .then((redis) => {
            const changePromis = redis;
            changePromis.Promise = global.Promise;
            const rootRouter = new Router({
                prefix: _.isUndefined(domainName) ? '' : domainName
            });
            // create server
            const server = new inversify_koa_utils_1.InversifyKoaServer(ioc_1.container, rootRouter);
            server
                .setConfig((app) => {
                app.use(async (ctx, next) => {
                    try {
                        await next();
                    }
                    catch (err) {
                        const response = new GamaResponse_1.default(err.message);
                        const statusArray = _.map(_.toString(err.status));
                        if (_.size(statusArray) === 4 &&
                            statusArray[0] in ['8', '9', '7', '6', '5', '4', '3', '2', '1', '0']) {
                            // 這邊map是因為要抓取第一個數字開頭等於9就會跑error
                            if (statusArray[0] === '9') {
                                log.error(err.status, err.message, JSON.stringify(ctx.state.user) || '');
                            }
                            else {
                                log.warn(err.status, err.message, JSON.stringify(ctx.state.user) || '');
                            }
                            response.$status = err.status;
                        }
                        else {
                            ctx.status = err.status || 500;
                            log.error(err.stack, JSON.stringify(ctx.state.user) || '');
                            response.$status = ctx.status;
                            ctx.app.emit('error', err, ctx);
                        }
                        ctx.body = response;
                    }
                })
                    .use(cors({
                    origin: async (ctx) => {
                        // const withoutHttpsIP = _.replace(ctx.request.header.origin, 'https://', '');
                        // const ip = _.split(withoutHttpsIP, ':', 1)[0];
                        // const findIP = await redis.get(ip);
                        // if (_.isUndefined(findIP)) {
                        //     redis.set(ip, 1, 'EX', 60);
                        // } else if (_.toNumber(findIP) > 60) {
                        //     ctx.throw(422, new Error('ERROR'));
                        // } else {
                        //     redis.set(ip, _.toNumber(findIP) + 1);
                        // }
                        if (_.isUndefined(corsWhitelist) ||
                            _.size(corsWhitelist) === 0) {
                            return '*';
                        }
                        else if (_.includes(corsWhitelist, ctx.header.origin)) {
                            return '*';
                        }
                        else {
                            ctx.status = 404;
                            ctx.throw(422, new Error('Not Allow Cors'));
                            return false;
                        }
                    }
                }))
                    .use(log4())
                    .use(multer({
                    storage: multer.memoryStorage()
                }).any())
                    .use(bodyParser({
                    strict: false,
                    onerror: (err, ctx) => {
                        log.error(err);
                        ctx.throw(422, new Error('body parse error'));
                    }
                }));
                if (!_.isUndefined(middlewares) && _.size(middlewares) !== 0) {
                    _.forEach(middlewares, (middleware) => {
                        app.use(middleware);
                    });
                }
                app.use(jwt({ secret: jwtPrivateKey, passthrough: !jwtActive })
                    .unless({
                    path: _.isUndefined(initSetting.unlessPath) ? [] : initSetting.unlessPath
                }));
            })
                .setErrorConfig((app) => {
                app.use((ctx, next) => {
                    log.error(ctx.status, ctx.message, JSON.stringify(ctx.state.user) || '');
                    next();
                });
            });
            this.koaServer = server.build().listen(httpPort);
            if (!_.isUndefined(this.serverInitOnceEvents) && _.size(this.serverInitOnceEvents) !== 0) {
                _.forEach(this.serverInitOnceEvents, (element) => {
                    element.init();
                });
            }
            log.info('Http started listening on http://localhost:%s ...', httpPort);
        })
            .catch((e) => {
            log.error(e);
        });
    }
    async start() {
        await Promise.all([this.main]);
        if (!_.isUndefined(this.serverInitOnceEvents) && _.size(this.serverInitOnceEvents) !== 0) {
            _.forEach(this.serverInitOnceEvents, (element) => {
                element.doOnce();
                element.end();
            });
        }
        return this.koaServer;
    }
}
exports.default = GServer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9nZ3R0b280NC9EZXNrdG9wL2Jhc2VBUEkvc3JjLyIsInNvdXJjZXMiOlsiYXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsK0VBQW1FO0FBQ25FLDZEQUF5RDtBQUN6RCxpQ0FBaUM7QUFFakMsNkNBQTZDO0FBQzdDLCtCQUErQjtBQUMvQixtQ0FBbUM7QUFDbkMscUNBQXFDO0FBQ3JDLHFDQUFxQztBQUNyQyxrQ0FBa0M7QUFDbEMsNEJBQTRCO0FBQzVCLGdEQUFnRDtBQUNoRCxtQ0FBc0M7QUFDdEMsK0NBQXdDO0FBQ3hDLHdEQUFvRDtBQUNwRCx3REFBaUQ7QUFJakQsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNwQztJQUlJLFlBQVksV0FBd0I7UUFDaEMsSUFBSSxXQUFXLENBQUM7UUFDaEIsSUFBSSxVQUFVLENBQUM7UUFDZixpQkFBaUI7UUFDakIsSUFBSSxhQUFhLENBQUM7UUFDbEIsSUFBSSxTQUFTLENBQUM7UUFDZCxJQUFJLFFBQVEsQ0FBQztRQUNiLElBQUksYUFBYSxDQUFDO1FBQ2xCLElBQUksSUFBc0IsQ0FBQztRQUMzQixJQUFJLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsRUFBRTtZQUM3QixXQUFXLEdBQUcsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQztZQUMzRixJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUMzQixXQUFXLEdBQUcsU0FBUyxDQUFDO2FBQzNCO1lBQ0QsSUFBSSxDQUFDLG9CQUFvQixHQUFHLENBQUMsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMs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QUFDO0lBQzFCLENBQUM7Q0FDSjtBQS9JRCwwQkErSUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTZXJ2ZXIgfSBmcm9tICdodHRwJztcbmltcG9ydCB7IGJ1aWxkUHJvdmlkZXJNb2R1bGUgfSBmcm9tICdpbnZlcnNpZnktYmluZGluZy1kZWNvcmF0b3JzJztcbmltcG9ydCB7IEludmVyc2lmeUtvYVNlcnZlciB9IGZyb20gJ2ludmVyc2lmeS1rb2EtdXRpbHMnO1xuaW1wb3J0ICogYXMgUmVkaXMgZnJvbSAnaW9yZWRpcyc7XG5pbXBvcnQgeyBNaWRkbGV3YXJlIH0gZnJvbSAna29hJztcbmltcG9ydCAqIGFzIGJvZHlQYXJzZXIgZnJvbSAna29hLWJvZHlwYXJzZXInO1xuaW1wb3J0ICogYXMgand0IGZyb20gJ2tvYS1qd3QnO1xuaW1wb3J0ICogYXMgbG9nNGpzIGZyb20gJ2tvYS1sb2c0JztcbmltcG9ydCAqIGFzIG11bHRlciBmcm9tICdrb2EtbXVsdGVyJztcbmltcG9ydCAqIGFzIFJvdXRlciBmcm9tICdrb2Etcm91dGVyJztcbmltcG9ydCAqIGFzIGNvcnMgZnJvbSAna29hMi1jb3JzJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAqIGFzIGRlZkNvbmZpZyBmcm9tICcuL2NvbmZpZy9kZWZjb25maWcnO1xuaW1wb3J0IHsgY29udGFpbmVyIH0gZnJvbSAnLi9pb2MvaW9jJztcbmltcG9ydCBJb2NUcmFjZXIgZnJvbSAnLi9pb2MvaW9jVHJhY2VyJztcbmltcG9ydCBrb2FMb2c0anMgZnJvbSAnLi9taWRkbGV3YXJlcy9sb2dnZXIvbG9nNGpzJztcbmltcG9ydCBHYW1hUmVzcG9uc2UgZnJvbSAnLi9tb2RlbHMvR2FtYVJlc3BvbnNlJztcbmltcG9ydCBJbml0U2V0dGluZyBmcm9tICcuL21vZGVscy9Jbml0U2V0dGluZyc7XG5pbXBvcnQgSVNlcnZlckluaXRPbmNlRXZlbnQgZnJvbSAnLi9TZXJ2ZXJFdmVudC9TZXJ2ZXJJbml0T25jZUV2ZW50JztcblxuY29uc3QgbG9nID0gbG9nNGpzLmdldExvZ2dlcignQXBwJyk7XG5leHBvcnQgZGVmYXVsdCBjbGFzcyBHU2VydmVyIHtcbiAgICBwcml2YXRlIG1haW46IFByb21pc2U8YW55PjtcbiAgICBwcml2YXRlIHNlcnZlckluaXRPbmNlRXZlbnRzOiBJU2VydmVySW5pdE9uY2VFdmVudFtdIHwgdW5kZWZpbmVkO1xuICAgIHByaXZhdGUga29hU2VydmVyOiBTZXJ2ZXI7XG4gICAgY29uc3RydWN0b3IoaW5pdFNldHRpbmc6IEluaXRTZXR0aW5nKSB7XG4gICAgICAgIGxldCBtaWRkbGV3YXJlcztcbiAgICAgICAgbGV0IGRvbWFpbk5hbWU7XG4gICAgICAgIC8vIGxldCBtcVNldHRpbmc7XG4gICAgICAgIGxldCBqd3RQcml2YXRlS2V5O1xuICAgICAgICBsZXQgand0QWN0aXZlO1xuICAgICAgICBsZXQgaHR0cFBvcnQ7XG4gICAgICAgIGxldCBjb3JzV2hpdGVsaXN0O1xuICAgICAgICBsZXQgbG9nNDogKCkgPT4gTWlkZGxld2FyZTtcbiAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nKSkge1xuICAgICAgICAgICAgbWlkZGxld2FyZXMgPSBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLm1pZGRsZXdhcmVzKSA/IHVuZGVmaW5lZCA6IGluaXRTZXR0aW5nLm1pZGRsZXdhcmVzO1xuICAgICAgICAgICAgaWYgKF8uc2l6ZShtaWRkbGV3YXJlcykgPT09IDApIHtcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlcyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2VydmVySW5pdE9uY2VFdmVudHMgPSBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLmluaURhdGEpID8gdW5kZWZpbmVkIDogaW5pdFNldHRpbmcuaW5pRGF0YTtcbiAgICAgICAgICAgIGNvcnNXaGl0ZWxpc3QgPSBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLmNvcnNXaGl0ZWxpc3QpID8gdW5kZWZpbmVkIDogaW5pdFNldHRpbmcuY29yc1doaXRlbGlzdDtcbiAgICAgICAgICAgIGRvbWFpbk5hbWUgPSBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLmRvbWFpbk5hbWUpID8gdW5kZWZpbmVkIDogaW5pdFNldHRpbmcuZG9tYWluTmFtZTtcbiAgICAgICAgICAgIC8vIG1xU2V0dGluZyA9IF8uaXNVbmRlZmluZWQoaW5pdFNldHRpbmcubXFTZXR0aW5nKSA/IHVuZGVmaW5lZCA6IGluaXRTZXR0aW5nLm1xU2V0dGluZztcbiAgICAgICAgICAgIGp3dFByaXZhdGVLZXkgPSBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLmp3dFByaXZhdGVLZXkpID9cbiAgICAgICAgICAgICAgICBkZWZDb25maWcuand0LnByaXZhdGVLZXkgOiBpbml0U2V0dGluZy5qd3RQcml2YXRlS2V5O1xuICAgICAgICAgICAgand0QWN0aXZlID0gXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZy5qd3RBY3RpdmUpID8gZGVmQ29uZmlnLmp3dC5hY3RpdmUgOiBpbml0U2V0dGluZy5qd3RBY3RpdmU7XG4gICAgICAgICAgICBodHRwUG9ydCA9IF8uaXNVbmRlZmluZWQoaW5pdFNldHRpbmcuaHR0cFBvcnQpID8gZGVmQ29uZmlnLmh0dHBQb3J0IDogaW5pdFNldHRpbmcuaHR0cFBvcnQ7XG4gICAgICAgICAgICBodHRwUG9ydCA9IF8uaXNVbmRlZmluZWQoaW5pdFNldHRpbmcuaHR0cFBvcnQpID8gZGVmQ29uZmlnLmh0dHBQb3J0IDogaW5pdFNldHRpbmcuaHR0cFBvcnQ7XG4gICAgICAgICAgICBsb2c0ID0gXy5pc0Z1bmN0aW9uKGluaXRTZXR0aW5nLmxvZzQpID8ga29hTG9nNGpzIDogaW5pdFNldHRpbmcubG9nNCE7XG4gICAgICAgICAgICBjb250YWluZXIubG9hZChidWlsZFByb3ZpZGVyTW9kdWxlKCkpO1xuICAgICAgICAgICAgaWYgKGluaXRTZXR0aW5nLmZpbHRlcnNPcGVuKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaW9jVHJhY2VyID0gbmV3IElvY1RyYWNlcihpbml0U2V0dGluZy5maWx0ZXJzKTtcbiAgICAgICAgICAgICAgICBpb2NUcmFjZXIuYXBwbHkoY29udGFpbmVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1haW4gPSBQcm9taXNlLnJlc29sdmUobmV3IFJlZGlzKGluaXRTZXR0aW5nLnBhdGhkYikpXG4gICAgICAgICAgICAudGhlbigocmVkaXMpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjaGFuZ2VQcm9taXM6IGFueSA9IHJlZGlzO1xuICAgICAgICAgICAgICAgIGNoYW5nZVByb21pcy5Qcm9taXNlID0gZ2xvYmFsLlByb21pc2U7XG4gICAgICAgICAgICAgICAgY29uc3Qgcm9vdFJvdXRlciA9IG5ldyBSb3V0ZXIoe1xuICAgICAgICAgICAgICAgICAgICBwcmVmaXg6IF8uaXNVbmRlZmluZWQoZG9tYWluTmFtZSkgPyAnJyA6IGRvbWFpbk5hbWVcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAvLyBjcmVhdGUgc2VydmVyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VydmVyID0gbmV3IEludmVyc2lmeUtvYVNlcnZlcihjb250YWluZXIsIHJvb3RSb3V0ZXIpO1xuICAgICAgICAgICAgICAgIHNlcnZlclxuICAgICAgICAgICAgICAgICAgICAuc2V0Q29uZmlnKChhcHApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC51c2UoYXN5bmMgKGN0eCwgbmV4dCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IG5leHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBuZXcgR2FtYVJlc3BvbnNlKGVyci5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhdHVzQXJyYXkgPSBfLm1hcChfLnRvU3RyaW5nKGVyci5zdGF0dXMpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF8uc2l6ZShzdGF0dXNBcnJheSkgPT09IDQgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1c0FycmF5WzBdIGluIFsnOCcsICc5JywgJzcnLCAnNicsICc1JywgJzQnLCAnMycsICcyJywgJzEnLCAnMCddKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyDpgJnpgoptYXDmmK/lm6DngrropoHmipPlj5bnrKzkuIDlgIvmlbjlrZfplovpoK3nrYnmlrw55bCx5pyD6LeRZXJyb3JcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0dXNBcnJheVswXSA9PT0gJzknKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nLmVycm9yKGVyci5zdGF0dXMsIGVyci5tZXNzYWdlLCBKU09OLnN0cmluZ2lmeShjdHguc3RhdGUudXNlcikgfHwgJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cud2FybihlcnIuc3RhdHVzLCBlcnIubWVzc2FnZSwgSlNPTi5zdHJpbmdpZnkoY3R4LnN0YXRlLnVzZXIpIHx8ICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLiRzdGF0dXMgPSBlcnIuc3RhdHVzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LnN0YXR1cyA9IGVyci5zdGF0dXMgfHwgNTAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nLmVycm9yKGVyci5zdGFjaywgSlNPTi5zdHJpbmdpZnkoY3R4LnN0YXRlLnVzZXIpIHx8ICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLiRzdGF0dXMgPSBjdHguc3RhdHVzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmFwcC5lbWl0KCdlcnJvcicsIGVyciwgY3R4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5ib2R5ID0gcmVzcG9uc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudXNlKGNvcnMoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW46IGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnN0IHdpdGhvdXRIdHRwc0lQID0gXy5yZXBsYWNlKGN0eC5yZXF1ZXN0LmhlYWRlci5vcmlnaW4sICdodHRwczovLycsICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnN0IGlwID0gXy5zcGxpdCh3aXRob3V0SHR0cHNJUCwgJzonLCAxKVswXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnN0IGZpbmRJUCA9IGF3YWl0IHJlZGlzLmdldChpcCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiAoXy5pc1VuZGVmaW5lZChmaW5kSVApKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgcmVkaXMuc2V0KGlwLCAxLCAnRVgnLCA2MCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB9IGVsc2UgaWYgKF8udG9OdW1iZXIoZmluZElQKSA+IDYwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgY3R4LnRocm93KDQyMiwgbmV3IEVycm9yKCdFUlJPUicpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgcmVkaXMuc2V0KGlwLCBfLnRvTnVtYmVyKGZpbmRJUCkgKyAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfLmlzVW5kZWZpbmVkKGNvcnNXaGl0ZWxpc3QpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5zaXplKGNvcnNXaGl0ZWxpc3QpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcqJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoXy5pbmNsdWRlcyhjb3JzV2hpdGVsaXN0LCBjdHguaGVhZGVyLm9yaWdpbikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJyonO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHguc3RhdHVzID0gNDA0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC50aHJvdyg0MjIsIG5ldyBFcnJvcignTm90IEFsbG93IENvcnMnKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnVzZShsb2c0KCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnVzZShtdWx0ZXIoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9yYWdlOiBtdWx0ZXIubWVtb3J5U3RvcmFnZSgpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkuYW55KCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnVzZShib2R5UGFyc2VyKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaWN0OiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25lcnJvcjogKGVyciwgY3R4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC50aHJvdyg0MjIsIG5ldyBFcnJvcignYm9keSBwYXJzZSBlcnJvcicpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghXy5pc1VuZGVmaW5lZChtaWRkbGV3YXJlcykgJiYgXy5zaXplKG1pZGRsZXdhcmVzKSAhPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uZm9yRWFjaChtaWRkbGV3YXJlcywgKG1pZGRsZXdhcmUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnVzZShtaWRkbGV3YXJlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC51c2Uoand0KHsgc2VjcmV0OiBqd3RQcml2YXRlS2V5LCBwYXNzdGhyb3VnaDogIWp3dEFjdGl2ZSB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC51bmxlc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoOiBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLnVubGVzc1BhdGgpID8gW10gOiBpbml0U2V0dGluZy51bmxlc3NQYXRoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAuc2V0RXJyb3JDb25maWcoKGFwcCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnVzZSgoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nLmVycm9yKGN0eC5zdGF0dXMsIGN0eC5tZXNzYWdlLCBKU09OLnN0cmluZ2lmeShjdHguc3RhdGUudXNlcikgfHwgJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLmtvYVNlcnZlciA9IHNlcnZlci5idWlsZCgpLmxpc3RlbihodHRwUG9ydCk7XG4gICAgICAgICAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKHRoaXMuc2VydmVySW5pdE9uY2VFdmVudHMpICYmIF8uc2l6ZSh0aGlzLnNlcnZlckluaXRPbmNlRXZlbnRzKSAhPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBfLmZvckVhY2godGhpcy5zZXJ2ZXJJbml0T25jZUV2ZW50cywgKGVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuaW5pdCgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbG9nLmluZm8oJ0h0dHAgc3RhcnRlZCBsaXN0ZW5pbmcgb24gaHR0cDovL2xvY2FsaG9zdDolcyAuLi4nLCBodHRwUG9ydCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKChlKSA9PiB7XG4gICAgICAgICAgICAgICAgbG9nLmVycm9yKGUpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuICAgIHB1YmxpYyBhc3luYyBzdGFydCgpIHtcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoW3RoaXMubWFpbl0pO1xuICAgICAgICBpZiAoIV8uaXNVbmRlZmluZWQodGhpcy5zZXJ2ZXJJbml0T25jZUV2ZW50cykgJiYgXy5zaXplKHRoaXMuc2VydmVySW5pdE9uY2VFdmVudHMpICE9PSAwKSB7XG4gICAgICAgICAgICBfLmZvckVhY2godGhpcy5zZXJ2ZXJJbml0T25jZUV2ZW50cywgKGVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICBlbGVtZW50LmRvT25jZSgpO1xuICAgICAgICAgICAgICAgIGVsZW1lbnQuZW5kKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5rb2FTZXJ2ZXI7XG4gICAgfVxufVxuIl19